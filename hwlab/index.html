<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>硬件管理</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />
    <style>
    .midbtn {
        height: 100%;
        width: 17%;
        margin-left: 1%;
        border: 0;
        padding: 0;
    }
    .midbar {
        position: absolute;
        width: 80%;
        left: 10%;
        height: 20%;
        top: 40%; 
        padding: 1%; 
        transition: all 0.5s ease-in-out;
    }
    .detailbar {
        position: absolute;
        width: 80%; 
        left: 10%; 
        height: 76%; 
        top: 22%;
        display: none;
    }
    </style>
</head>
<body>

    <img src="img/pos1.jpg" style="position: absolute; width: 50%; height: 50%; left: 0%; top: 0%; z-index: -1;"/>
    <img src="img/pos2.jpg" style="position: absolute; width: 50%; height: 50%; left: 0%; top: 50%; z-index: -1;"/>
    <img src="img/pos3.jpg" style="position: absolute; width: 50%; height: 50%; left: 50%; top: 0%; z-index: -1;"/>
    <img src="img/pos4.jpg" style="position: absolute; width: 50%; height: 50%; left: 50%; top: 50%; z-index: -1;"/>

    <div class="midbar" style=" background-color: whitesmoke; opacity: 0.7;"></div>
    <div class="midbar">
        <button class="btn btn-primary midbtn" onclick="query_element()" id="btn_query">搜索</button>
        <button class="btn btn-success midbtn" onclick="add_element()" id="btn_add">添加元件</button>
        <button class="btn btn-warning midbtn" disabled>配单</button>
        <button class="btn btn-info midbtn" onclick="refresh_all()" id="btn_refresh">刷新</button>
        <button class="btn btn-secondary midbtn" onclick="toggle_show()" id="btn_ret">切换显示</button>
    </div>

    <div class="detailbar" style=" background-color: whitesmoke; opacity: 0.7;"></div>
    <div class="detailbar">
        <div style="position: absolute; overflow-y :auto; width: 40%; height: 100%;">
            <div class="list-group" id="elelist">
                <!-- <a href="#" class="list-group-item list-group-item-action active">Cras justo odio</a>
                <a href="#" class="list-group-item list-group-item-action">Dapibus ac facilisis in</a> -->
            </div>
        </div>
        <div style="position: absolute; height: 100%; width: 60%; left: 40%;">
            <div style="height: 10%; width: 100%;">
                <div style="width: 100%; height: 100%; padding-top: 10px;text-align: center; font-size: 150%; font-weight: 900;" id="title">元件属性</div>
            </div>
            <div style="height: 90%; background-color: snow; width: 100%; overflow-y :auto; padding: 15px;">
                <form>
                    <div class="form-inline">
                        <label for="name" class="col-sm-4 col-form-label">元件名称</label>
                        <input type="text" class="form-control col-sm-8" id="name" placeholder="name" readonly value="C202">
                    </div>
                    <div class="form-inline" style="margin-top: 10px;">
                        <label for="quantity" class="col-sm-4 col-form-label">数量</label>
                        <button type="button" class="btn btn-success col-sm-2">-</button>
                        <input type="number" class="form-control col-sm-4" id="quantity" placeholder="quantity">
                        <button type="button" class="btn btn-success col-sm-2">+</button>
                    </div>
                    <div class="form-inline" style="margin-top: 10px;">
                        <label for="position" class="col-sm-4 col-form-label">放置地点</label>
                        <select class="form-control col-sm-8" id="position"></select>
                    </div>
                    <div class="form-inline" style="margin-top: 10px;">
                        <label for="tag" class="col-sm-4 col-form-label">添加标签</label>
                        <select class="form-control col-sm-8" id="tag" onchange="tag_change()"></select>
                    </div>
                    <div class="form-inline" style="margin-top: 10px;" id="tags">
                        <input type="text" class="form-control col-sm-4" id="diy_tag" placeholder="自定义标签" style="margin-left: 5px;" onblur="add_diy_tag()"/>
                    </div>
                    <div class="form-group">
                        <img src="img/default.jpg" style="width: 100%; border: 1px solid black; margin-top: 10px;" id="image"/>
                    </div>
                    <div class="form-group">
                        <label for="description">详细描述信息（备注）</label>
                        <textarea class="form-control" id="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.form.js"></script>
    <script src="js/jsrender.min.js"></script>
    <script src="js/popper.min.js"></script>

    <script type="text/html" id="tag_template">
        <div class="alert {{:class}}" role="alert" style="display: inline-block; padding: 6px; margin: 5px;" id="{{:id}}">
            {{:name}}
            <button type="button" class="close" style="line-height: 0.8;" onclick="del_tag('{{:id}}')">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    </script>

    <script type="text/html" id="ele_template">
        <a class="list-group-item list-group-item-action" id="{{:id}}" onclick="select_ele('{{:id}}')">{{:name}}</a>
    </script>

    <script>

    var sys_positions = [
        {"name": "未知地点"},
        {"name": "蓝盒子"},
        {"name": "红盒子"},
        {"name": "铁柜1"},
        {"name": "铁柜2"},
        {"name": "蓝色手推车"},
        {"name": "红色手推车"}
    ];

    var sys_tags = [
        {"name": "常用元件", "class": "alert-success"},
        {"name": "需要增添", "class": "alert-warning"},
        {"name": "弃用", "class": "alert-danger"},
        {"name": "存档硬件", "class": "alert-dark"}
    ];

    var show_status = false;
    var status = "none";
    var active_ele = null;
    var idcnt = 0;  // 用来分配全局id
    var queried_data = [];
    var ordered_data = [];
    var ele_map = {};
    function allocID() {
        idcnt += 1;
        return "gid_" + idcnt;
    }
    function detail_show() {
        $(".midbar").css("transform", "translateY(-200%)");
        $(".detailbar").show(500);
        show_status = true;
    }
    function detail_hide() {
        $(".midbar").css("transform", "translateY(0)");
        $(".detailbar").hide(500);
        show_status = false;
    }
    function midbar_return() {  // 销毁没有保存的东西，重新初始化
        $("#title").html("元件属性");
        $("#name").val("");
        $("#name").attr("readonly");
        $("#btn_add").removeClass("btn-danger");
        $("#btn_add").addClass("btn-success");
        $("#btn_add").html("添加元件");
        $("#btn_ret").html("切换显示");
        status = "none";
        detail_hide();
    }
    function toggle_show() {
        if (show_status) {
            midbar_return();
        } else {
            detail_show();
        }
    }
    function global_lock(lock=true) {
        if (lock) $("#btn_add").attr("disabled", "disabled"); else $("#btn_add").removeAttr("disabled");
        if (lock) $("#btn_query").attr("disabled", "disabled"); else $("#btn_query").removeAttr("disabled");
        if (lock) $("#btn_refresh").attr("disabled", "disabled"); else $("#btn_refresh").removeAttr("disabled");
        if (lock) $("#btn_ret").attr("disabled", "disabled"); else $("#btn_ret").removeAttr("disabled");
    }

    $(function() {
        for (let i=0; i<sys_positions.length; ++i) {
            $("#position").append("<option>" + sys_positions[i].name + "</option>");
        }
        $("#tag").append("<option>点击添加</option>");
        for (let i=0; i<sys_tags.length; ++i) {
            $("#tag").append("<option>" + sys_tags[i].name + "</option>");
        }
        refresh_all();
        toggle_show();
    })

    function show_queried_data() {
        console.log(queried_data);
        $("#elelist").children().remove();
        ele_map = {};
        ordered_data = [];
        for (let i=0; i<queried_data.length; ++i) {
            ordered_data.push(queried_data[i]);
        }
        // TODO 排序
        for (let i=0; i < ordered_data.length; ++i) {
            let id = allocID();
            ordered_data[i]["id"] = id;
            ele_map[id] = ordered_data[i];
            $("#elelist").append($.templates("#ele_template").render({"name": ordered_data[i].name, "id": id}));
        }
        if (ordered_data.length != 0) {
            select_ele(ordered_data[0].id);
        }
    }

    function refresh_all() {
        $.get("query_all", function(data) {
            queried_data = data.data;
            show_queried_data();
        })
    }

    function adding_add_tag(tag) {
        let children = $("#tags").children("div");
        for (let i=0; i<children.length; ++i) {
            if (tag == children[i].innerText.slice(0,-2)) return false;
        }
        $("#tags").prepend($.templates("#tag_template").render({"name": tag, "class": get_alert_class(tag), "id": allocID()}));
        return true;
    }

    function tag_change() {
        if (status == "adding") {  // 每一次都添加一个tag
            let tag = $("#tag option:selected").text();
            if (tag != "点击添加") {  // 添加一个tag到tags里面
                adding_add_tag(tag);
            }
            console.log(tag);
        } else {
            alert("系统错误 tag_change");
        }
    }

    function del_tag(id) {
        if (status == "adding") {
            $("#" + id).remove();
        } else {
            alert("系统错误 del_tag");
        }
    }

    function add_diy_tag() {
        if (status == "adding") {
            let tagname = htmlEscape($("#diy_tag").val());
            $("#diy_tag").val("");
            if (tagname.length != 0) {
                adding_add_tag(tagname);
            }
        } else {
            alert("系统错误 add_diy_tag");
        }
    }

    function add_element() {
        if (status == "adding") {
            // check input
            let name = $("#name").val();
            if (name.length == 0) { alert("元件名称不能为空"); return; }
            let quantity = $("#quantity").val();
            if (! /^[0-9]+$/.test(quantity)) { alert("元件数量必需为非负整数"); return; }
            quantity = parseInt(quantity);
            let position = $("#position option:selected").text();
            let description = $("#description").val();
            let image = $("#image").attr("src");
            let d = new Date();
            let lastmodified = d.getTime();
            let tags = [];
            let children = $("#tags").children("div");
            for (let i=0; i<children.length; ++i) {
                tags.push(children[i].innerText.slice(0,-2));
            }
            console.log(tags);
            let ele = {
                "name": name,
                "quantity": quantity,
                "position": position,
                "description": description,
                "image": image,
                "lastmodified": lastmodified
            }
            let data = JSON.parse(JSON.stringify(ele));  // copy the object
            for (let i=0; i<tags.length; ++i) {
                data["tag" + i] = tags[i];
            }
            global_lock(true);
            $.ajax({
                type: 'POST',
                url: "add",
                data: data,
                success: function(msg) {
                    console.log(msg);
                    if (msg == "OK") {
                        alert("添加成功");
                        ele["tag"] = tags;  // 设置数组
                        console.log(ele);
                    } else alert("添加失败");
                    global_lock(false);
                }
            })
        } else {
            $("#title").html("添加元件");
            $("#name").val("");
            $("#name").removeAttr("readonly");
            $("#btn_add").removeClass("btn-success");
            $("#btn_add").addClass("btn-danger");
            $("#btn_add").html("确认添加");
            $("#btn_ret").html("取消添加");
            $("#tags").children("div").remove();
            detail_show();
            status = "adding";
        }
    }

    function get_alert_class(tag) {
        let alert_class = "alert-primary";
        for (let i=0; i<sys_tags.length; ++i) {
            if (tag == sys_tags[i].name) alert_class = sys_tags[i].class;
        }
        return alert_class
    }

    function select_ele(id) {
        if (! (id in ele_map)) { alert("系统错误 select_ele no id"); return; }
        let ele = ele_map[id];
        if (status == "adding") {
            alert("请先退出添加模式");
        } else if (status == "none" || status == "modifying") {
            $("#elelist").children().removeClass("active");
            $("#" + id).addClass("active");
            $("#title").html("元件属性");
            $("#name").val(ele.name);
            $("#name").attr("readonly");
            $("#quantity").val(ele.quantity);
            $("#position").find("option").removeAttr("selected");
            $("#position").find("option:contains('" + ele.position + "')").attr("selected",true);
            $("#tags").children("div").remove();
            for (let i=0; i<ele.tag.length; ++i) {
                $("#tags").prepend($.templates("#tag_template").render({"name": ele.tag[i], "class": get_alert_class(ele.tag[i]), "id": allocID()}));
            }
            $("#btn_add").removeClass("btn-danger");
            $("#btn_add").addClass("btn-success");
            $("#btn_add").html("添加元件");
            $("#btn_ret").html("切换显示");
            detail_show();
            active_ele = ele;
            status = "modifying";
        }
    }

    function htmlEscape(text) { 
        return text.replace(/[<>"&]/g, function(match, pos, originalText) {
            switch(match) {
                case "<": return "&lt;"; 
                case ">":return "&gt;";
                case "&":return "&amp;"; 
                case "\"":return "&quot;"; 
            } 
        });
    }

    </script>
    
</body>
</html>